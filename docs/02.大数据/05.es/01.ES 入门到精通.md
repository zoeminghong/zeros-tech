---
title: ES å…¥é—¨åˆ°ç²¾é€š
date: 2021-02-08 09:57:36
permalink: /pages/6d6fe4/
categories: 
  - å¤§æ•°æ®
  - es
tags: 
  - null
comment: true
---
## æ–‡æ¡£

ä¸­æ–‡æ–‡æ¡£ï¼šhttps://doc.codingdict.com/elasticsearch/

## å‚æ•°è¯´æ˜

**wait_for_active_shards**

åœ¨5.0.0ç‰ˆæœ¬æ–°å¼•å…¥çš„ä¸€ä¸ªå‚æ•°ï¼Œè¡¨ç¤ºç­‰å¾…æ´»è·ƒçš„åˆ†ç‰‡æ•°ã€‚ä½œç”¨è·Ÿconsistencyç±»ä¼¼ï¼Œå¯ä»¥è®¾ç½®æˆallæˆ–è€…ä»»æ„æ­£æ•´æ•°ã€‚

æ¯”å¦‚åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼šé›†ç¾¤ä¸­æœ‰3ä¸ªèŠ‚ç‚¹node-1ã€node-2å’Œnode-3ï¼Œå¹¶ä¸”ç´¢å¼•ä¸­çš„åˆ†ç‰‡éœ€è¦å¤åˆ¶3ä»½ã€‚é‚£ä¹ˆè¯¥ç´¢å¼•ä¸€å…±æ‹¥æœ‰4ä¸ªåˆ†ç‰‡ï¼ŒåŒ…æ‹¬1ä¸ªä¸»åˆ†ç‰‡å’Œ3ä¸ªå¤åˆ¶åˆ†ç‰‡ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œç´¢å¼•æ“ä½œåªéœ€è¦ç­‰å¾…ä¸»åˆ†ç‰‡å¯ç”¨(wait_for_active_shardsä¸º1)å³å¯ã€‚

å¦‚æœnode-2å’Œnode-3èŠ‚ç‚¹æŒ‚äº†ï¼Œç´¢å¼•æ“ä½œæ˜¯ä¸ä¼šå—å½±å“çš„(wait_for_active_shardsé»˜è®¤ä¸º1)ï¼›å¦‚æœè®¾ç½®äº†wait_for_active_shardsä¸º3ï¼Œé‚£ä¹ˆéœ€è¦3ä¸ªèŠ‚ç‚¹å…¨éƒ¨å­˜æ´»ï¼›å¦‚æœè®¾ç½®äº†wait_for_active_shardsä¸º4æˆ–è€…all(ä¸€å…±4ä¸ªåˆ†ç‰‡ï¼Œ4å’Œallæ˜¯ä¸€æ ·çš„æ•ˆæœ)ï¼Œé‚£ä¹ˆè¯¥é›†ç¾¤ä¸­çš„ç´¢å¼•æ“ä½œæ°¸è¿œéƒ½ä¼šå¤±è´¥ï¼Œå› ä¸ºé›†ç¾¤ä¸€å…±å°±3ä¸ªèŠ‚ç‚¹ï¼Œä¸èƒ½å¤„ç†æ‰€æœ‰çš„4ä¸ªåˆ†ç‰‡ã€‚

## ILM

ILMç”¨äºè®¾ç½®ç´¢å¼•ä¸‹æ•°æ®çš„è¿‡æœŸæ—¶é—´ç­–ç•¥å’Œå†·çƒ­æ•°æ®å­˜å‚¨å®ç°ã€‚

> ğŸ“¢ éœ€è¦å…ˆåˆ›å»ºILMç­–ç•¥ï¼Œå†åˆ›å»ºç´¢å¼•ï¼Œå¦åˆ™ï¼Œ`/[index_name]/_ilm/explain` æ—¶ï¼Œmanaged=falseã€‚æˆ–è€…éœ€è¦é‡å»ºç´¢å¼•ã€‚
>
> rollover_aliasåç§°ä¹Ÿæ”¯æŒä½¿ç”¨â€»ã€‚

```
GET /_template/[template_name]
{
    "index_patterns": [
      "index_name-*" â‘ 
    ],
      "settings": {
        "number_of_shards": 1,
        "number_of_replicas": 1,
        "index.lifecycle.name": "ilp-policy_name",â‘¡
        "index.lifecycle.rollover_alias": "index_name-*"â‘¢
      },
      "mappings": {
        "properties" : {
          "name": {
            "type": "text",
            "fields": {
              "keyword": {
                "type": "keyword",
                "ignore_above": 256
              }
            }
          },
          "age":{
              "type":"long"
          }
       }
     }
  }
  
// æŸ¥çœ‹ILPç­–ç•¥çš„é…ç½®
GET /_ilm/policy/[ilp-policy_name]

// æŸ¥çœ‹ILMçŠ¶æ€
GET _ilm/status

// å¼€å§‹ilm
POST /_ilm/start

// æŸ¥çœ‹ilm ç´¢å¼•é”™è¯¯ä¿¡æ¯
GET /[index_name]/_ilm/explain

// è·å–é›†ç¾¤é…ç½®
GET /_cluster/settings

PUT _cluster/settings
{
"persistent": {
"indices.lifecycle.poll_interval":"1s"
}
}

// åˆ·æ–°ç´¢å¼•
POST used-cars-api-sit-*/_refresh

// é‡å»ºç´¢å¼•
POST _reindex
{
  "source": {
    "index": "used-cars-api-sit-",
    "size": 5000
  },
  "dest": {
    "index": "used-cars-api-sit-",
    "op_type": "create"
  }
}

```

Relation:

- https://www.elastic.co/guide/en/elasticsearch/reference/7.16/index-lifecycle-error-handling.html
- https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html
- ğŸ‘ğŸ»http://code2life.top/2019/06/05/0044-es-ilm-introduction/
- ğŸ‘ğŸ»https://www.elastic.co/guide/en/elasticsearch/reference/current/index-lifecycle-management.html
- https://www.elastic.co/guide/en/elasticsearch/reference/7.16/set-up-lifecycle-policy.html

ç»™ç´¢å¼•æ·»åŠ ILMç­–ç•¥æœ‰ä¸¤ä¸ªæ–¹å¼ï¼Œä¸€æ˜¯è°ƒç”¨ç›´æ¥Create/Update Indexçš„APIè®¾ç½®**å•ä¸ªç´¢å¼•**çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ç­–ç•¥ï¼ŒäºŒæ˜¯é€šè¿‡**Index Template**å…³è”ILMç­–ç•¥ï¼Œè¿™æ ·å¯ä»¥ä¸€åŠ³æ°¸é€¸ï¼Œæ‰€æœ‰åŒä¸€ä¸ªTemplateçš„Indiceséƒ½èƒ½è¢«ILMæ§åˆ¶ã€‚Filebeat MetricBeatç­‰å…¨å®¶æ¡¶ç»„ä»¶ä¹Ÿéƒ½æ˜¯ç”¨è¿™ç§æ–¹å¼çš„ã€‚æˆ‘ä»¬æ¥å°è¯•æŠŠç°æœ‰çš„ä¸€ä¸ªIndex Templateè®¾ç½®ILMã€‚

##### ç¬¬ä¸€æ­¥, åˆ›å»ºILMç­–ç•¥, æ¯”å¦‚è¿™æ ·çš„ç­–ç•¥: **æ¯å¤©æˆ–è€…è¾¾åˆ°50GBè½®æ»šä¸€æ¬¡, 30å¤©åç¼©æˆ1ä¸ªåˆ†ç‰‡,åˆå¹¶ç´¢å¼•,å¹¶ä¸”å¢åŠ å‰¯æœ¬, 60å¤©åè½¬ç§»åˆ°å†·æ•°æ®èŠ‚ç‚¹, 90å¤©ååˆ é™¤**:

```
PUT _ilm/policy/log_policy
{
  "policy": {
    "phases": {
      "hot": {
        "actions": {
          "rollover": {
            "max_age": "1d",
            "max_size": "50G"
          }
        }
      },
      "warm": {
        "min_age": "30d",
        "actions": {
          "forcemerge": {
            "max_num_segments": 1
          },
          "shrink": {
            "number_of_shards": 1
          },
          "allocate": {
            "number_of_replicas": 2
          }
        }
      },
      "cold": {
        "min_age": "60d",
        "actions": {
          "allocate": {
            "require": {
              "box_type": "cold"
            }
          }
        }
      },
      "delete": {
        "min_age": "90d",
        "actions": {
          "delete": {}
        }
      }
    }
  }
}
```

##### ç¬¬äºŒæ­¥ æ‰¾åˆ°Template, é€šè¿‡ **GET _template/log-xxx** æŸ¥çœ‹ä¸€ä¸‹setting, ç¡®è®¤æ²¡æœ‰ settings.index.lifecycle.name/rollover_alias è¿™ä¸¤ä¸ªå±æ€§

##### ç¬¬ä¸‰æ­¥ æ›´æ–°è¿™ä¸ªIndex Template, åº”ç”¨ç¬¬ä¸€æ­¥åˆ›å»ºçš„ â€œlog_policyâ€

```
PUT _template/log-xxx
{
  "index_patterns": ["log-xxx-*"], 
  "settings": {
    "number_of_shards": 1,
    "number_of_replicas": 1,
    "index.lifecycle.name": "log_policy", 
    "index.lifecycle.rollover_alias": "log-xxx"
  }
}
```

##### ç¬¬å››æ­¥ æŸ¥çœ‹Policyä»¥åŠTemplateåˆ›å»ºå‡ºæ¥çš„æ–°çš„ç´¢å¼•ç­–ç•¥æ˜¯å¦åº”ç”¨æˆåŠŸ

```
GET _ilm/policy

GET log-xxx-*/_ilm/explain
# managed ä¸º true å³å·²ç»è¢«ILMç®¡ç†
```

åªè¦å‡ ä¸ªAPIå°±èƒ½å®Œæˆè¿™ä¹ˆå¤æ‚çš„ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†!

**æ³¨æ„ï¼š**

**1.ä½¿ç”¨æ–°çš„ç´¢å¼•æ¨¡æ¿è¿›è¡Œæµ‹è¯•çš„æ—¶å€™ï¼Œéœ€è¦æ–°å»ºä¸€ä¸ªæ¨¡æ¿å¯¹åº”çš„ç´¢å¼•ï¼Œå¦åˆ™åœ¨æ­¤å¤„çš„ä¸‹æ‹‰æ¡†ä¸­å°†ä¸ä¼šå‡ºç°è¯¥ç´¢å¼•æ¨¡æ¿**

**2.å¦‚æœåŸç´¢å¼•æ¨¡æ¿ä¸­å·²ç»å­˜åœ¨ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç­–ç•¥ï¼Œè¦†ç›–åæ–°ç”Ÿæˆçš„ç´¢å¼•ä¼šä½¿ç”¨æ–°è¦†ç›–çš„ç­–ç•¥ï¼Œä½†æ˜¯å·²ç»å­˜åœ¨çš„ç´¢å¼•ä»ç„¶æ˜¯å°±ç­–ç•¥ï¼Œä¸ä¼šè§¦å‘åˆ é™¤ï¼Œéœ€è¦æ‰‹åŠ¨åˆ é™¤**

**é—®é¢˜ï¼š**

1ã€Filebeat ä¸­ ILMä¸ç”Ÿæ•ˆçš„åŸå› ï¼Ÿ

```shell
# filebeat é…ç½®å…³é—­ ILM å³å¯è§£å†³Index Patternä¸ç”Ÿæ•ˆçš„é—®é¢˜
setup.ilm.enabled: false
```

2ã€å†å²å·²ç»å­˜åœ¨çš„ç´¢å¼•æ·»åŠ åˆ é™¤ç­–ç•¥

```
// ç´¢å¼•åç§°
PUT used-cars-api-sit*/_settings 
{
// ç­–ç•¥åç§°
  "lifecycle.name": "log-history-ilm-policy"
}
```

