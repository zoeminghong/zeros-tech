---
title: APISIX
date: 2021-09-16 09:04:57
permalink: /pages/92bacc/
categories:
  - ÊäÄÊúØ
  - ‰∏≠Èó¥‰ª∂
tags:
  - 
---
# APISIX

[TOC]

## ÂæÖÈúÄË¶ÅÊï¥ÁêÜÂÜÖÂÆπ

- [ ] Â¶Ç‰ΩïÁºñÂÜôÊèí‰ª∂
  - [ ] Êèí‰ª∂ÊâßË°å‰ºòÂÖàÁ∫ß
- [ ] Êï¥‰ΩìÊû∂ÊûÑÊÉÖÂÜµ
- [ ] Â¶Ç‰ΩïÂÆûÁé∞ÁÅ∞Â∫¶ÈÉ®ÁΩ≤
  - [ ] ÁºñÂÜôÁÅ∞Â∫¶ÈÉ®ÁΩ≤Â∫îÁî®ÊñπÊ°àÂèäÂ≠òÂú®ÁöÑÈóÆÈ¢ò
- [ ] ÈôêÊµÅ
- [ ] ÊòØÂê¶Â≠òÂú®ÊúçÂä°ÈôçÁ∫ßÁ≠ñÁï•
- [ ] ÊùÉÈôêËÆ§ËØÅ
  - [ ] ÂÖ≥Ê≥®Ëá™ÂÆö‰πâÂÆûÁé∞
- [ ] Â§öÁßüÊà∑ÔºåÊï∞ÊçÆÈöîÁ¶ª
- [ ] APISIX ÊÄßËÉΩÊÉÖÂÜµÂèäÂÖ∂ÂéüÂõ†
- [ ] Êõ¥Êñ∞Áä∂ÊÄÅÔºåÊòØÂê¶Â≠òÂú®ÈòªÂ°û

## Ê¶ÇÂøµ

- Ë∑ØÁî±ÔºöÂÆö‰πâ‰∏Ä‰∫õËßÑÂàôÊù•ÂåπÈÖçÂÆ¢Êà∑Á´ØÁöÑËØ∑Ê±ÇÔºåÁÑ∂ÂêéÊ†πÊçÆÂåπÈÖçÁªìÊûúÂä†ËΩΩÂπ∂ÊâßË°åÁõ∏Â∫îÁöÑ Êèí‰ª∂ÔºåÂπ∂ÊääËØ∑Ê±ÇËΩ¨ÂèëÁªôÂà∞ÊåáÂÆö Upstream„ÄÇ
- ËÑöÊú¨Ôºö`Script` ÈÖçÁΩÆÂèØÁõ¥Êé•ÁªëÂÆöÂú® `Route` ‰∏ä„ÄÇScript` ‰∏é `Plugin` ‰∫íÊñ•Ôºå‰∏î‰ºòÂÖàÊâßË°å `Script„ÄÇ
- ÊúçÂä°Ôºö`Service` ÊòØÊüêÁ±ª API ÁöÑÊäΩË±°Ôºà‰πüÂèØ‰ª•ÁêÜËß£‰∏∫‰∏ÄÁªÑ Route ÁöÑÊäΩË±°Ôºâ„ÄÇÂÆÉÈÄöÂ∏∏‰∏é‰∏äÊ∏∏ÊúçÂä°ÊäΩË±°ÊòØ‰∏Ä‰∏ÄÂØπÂ∫îÁöÑÔºå`Route` ‰∏é `Service` ‰πãÈó¥ÔºåÈÄöÂ∏∏ÊòØ N:1 ÁöÑÂÖ≥Á≥ªÔºåService‰∏≠ÂåÖÂê´Êèí‰ª∂ÈÖçÁΩÆ‰ø°ÊÅØ„ÄÇ
- Ê∂àË¥πËÄÖÔºöConsumer ÊòØÊüêÁ±ªÊúçÂä°ÁöÑÊ∂àË¥πËÄÖÔºåÈúÄ‰∏éÁî®Êà∑ËÆ§ËØÅ‰ΩìÁ≥ªÈÖçÂêàÊâçËÉΩ‰ΩøÁî®„ÄÇ ÊØîÂ¶Ç‰∏çÂêåÁöÑ Consumer ËØ∑Ê±ÇÂêå‰∏Ä‰∏™ APIÔºåÁΩëÂÖ≥ÊúçÂä°Ê†πÊçÆÂΩìÂâçËØ∑Ê±ÇÁî®Êà∑‰ø°ÊÅØÔºåÂØπÂ∫î‰∏çÂêåÁöÑ Plugin Êàñ Upstream ÈÖçÁΩÆ„ÄÇ
- Upstream ÊòØËôöÊãü‰∏ªÊú∫ÊäΩË±°ÔºåÂØπÁªôÂÆöÁöÑÂ§ö‰∏™ÊúçÂä°ËäÇÁÇπÊåâÁÖßÈÖçÁΩÆËßÑÂàôËøõË°åË¥üËΩΩÂùáË°°„ÄÇ

### ÈáçË¶ÅÊñá‰ª∂ËØ¥Êòé

- *config.yaml* ‰∏∫ÈÖçÁΩÆÊñá‰ª∂
- apisix/deps/share/lua/5.1 ËØ•ÁõÆÂΩï‰∏ãÈù¢ÊòØopenrest‰æùËµñ‰ø°ÊÅØ

### ÈáçË¶ÅÊé•Âè£

- control APIÔºöhttps://apisix.apache.org/zh/docs/apisix/control-api/#get-v1schema
- Admin APIÔºöhttps://apisix.apache.org/zh/docs/apisix/admin-api

### ‰ºòÂÖàÁ∫ß

- ÂΩì Route Âíå Service ÈÉΩÂºÄÂêØÂêå‰∏Ä‰∏™Êèí‰ª∂Êó∂ÔºåRoute ÂèÇÊï∞ÁöÑ‰ºòÂÖàÁ∫ßÊòØÈ´ò‰∫é Service ÁöÑ
- Plugin ÈÖçÁΩÆÈÄâÊã©‰ºòÂÖàÁ∫ßÊÄªÊòØ `Consumer` > `Route` > `Service`

### ÁéØÂ¢ÉË¶ÅÊ±Ç

ETCDÔºö>3.4.0

### Docker ‰ΩøÁî®

```shell
docker-compose -f docker-compose.yml -p docker-apisix up -d
```

## Êèí‰ª∂

### Java Plugin Runner

https://apisix.apache.org/zh/blog/2021/06/21/use-Java-to-write-Apache-APISIX-plugins/

### Open-Id ConnectÔºàOIDCÔºâ

https://www.cnblogs.com/linianhui/p/openid-connect-core.html

[keycloak](https://www.keycloak.org/docs/latest/getting_started/index.html )

[ORY Hydra](https://github.com/ory/hydra)

### Ëá™ÂÆö‰πâÊèí‰ª∂

```lua
local plugin_name = "example-plugin"

local _M = {
    version = 0.1,
    priority = 0,
    name = plugin_name,
    schema = schema,
    metadata_schema = metadata_schema,
    type = 'auth', #Êèí‰ª∂Á±ªÂûã
    run_policy = 'prefer_route', #Áî®Êù•ÊéßÂà∂Êèí‰ª∂ÊâßË°å„ÄÇÂΩìËøô‰∏™Â≠óÊÆµËÆæÁΩÆÊàê prefer_route Êó∂Ôºå‰∏îËØ•Êèí‰ª∂ÂêåÊó∂ÈÖçÁΩÆÂú®ÂÖ®Â±ÄÂíåË∑ØÁî±Á∫ßÂà´ÔºåÈÇ£‰πàÂè™ÊúâË∑ØÁî±Á∫ßÂà´ÁöÑÈÖçÁΩÆÁîüÊïà„ÄÇ
}
```

RelationÔºöhttps://apisix.apache.org/zh/docs/apisix/plugin-develop/

### Êèí‰ª∂Ë∞ÉËØï

#### ÁéØÂ¢ÉÂáÜÂ§á

ÁéØÂ¢ÉÂáÜÂ§áÔºöhttps://apisix.apache.org/zh/docs/apisix/install-dependencies#mac-osx

ÁéØÂ¢ÉÂáÜÂ§áÔºöMacÁéØÂ¢É‰∏ã

```
brew install lua51
brew install openresty
brew install openresty-openssl111
brew install luarock34
brew install cpanminus
# Ê∫êÁ†ÅÁéØÂ¢É‰∏ã
cd apisix
git clone https://github.com/iresty/test-nginx.git
rm -rf test-nginx/.git
sudo cpanm --notest Test::Nginx IPC::Run > build.log 2>&1 || (cat build.log && exit 1)
export PERL5LIB=.:$PERL5LIB
make deps
```

Ubuntu ÁéØÂ¢ÉÂèÇËßÅÔºöhttp://coding.idealworld.group/2021/09/03/apisix-plugin-development/

**ÊµãËØïÁéØÂ¢É**

```
prove -Itest-nginx/lib -r t/plugin/limit-conn.t
```

**Áä∂ÊÄÅÁ†ÅËØ¥ÊòéÔºö**

- https://apisix.apache.org/zh/docs/apisix/debug-function

- https://githubmemory.com/repo/openresty/test-nginx#user-guide
- https://apisix.apache.org/zh/docs/apisix/how-to-build#%E6%AD%A5%E9%AA%A44%EF%BC%9A%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95%E6%A1%88%E4%BE%8B

**ÊâßË°åÂëΩ‰ª§Ôºö**

```
prove -Itest-nginx/lib -r t/plugin/limit-conn.t
TEST_NGINX_BINARY=/usr/local/bin/openresty prove -Itest-nginx/lib -r t/plugin/auth-dew/redis.t
```

**‰∏Ä‰∫õËØ¥ÊòéÔºö**

Â¶ÇÊûúÊâæ‰∏çÂà∞ÂØπÂ∫îÁöÑ Plugin configÔºåËØ•Ë∑ØÁî±‰∏äÁöÑËØ∑Ê±Ç‰ºöÊä• 503 ÈîôËØØ„ÄÇ

502ÂìçÂ∫îÂ§¥Ê≤°Êúâ`X-APISIX-Upstream-Status` ËØ¥ÊòéÊòØAPISIXËá™Ë∫´Êä•ÁöÑÔºåËøòÊ≤°ÊúâÂà∞upstreamÊúçÂä°„ÄÇ

ÂÖ≥‰∫é cpanm ‰ΩøÁî®ËØ¥Êòé

```
#ÂÆâË£Ö‰æùËµñÊñπÂºè
cpan Chocolate::Belgian
#ÂÆâË£Ö‰æùËµñÊñπÂºè
sudo perl -MCPAN -e shell
cpan[1]> install Test:LongString
geting started
```

#### Ê∑ªÂä†Êèí‰ª∂

Âú® `conf/config-default.yaml` Êñá‰ª∂ÁöÑplugins‰∏ãÈù¢Ê∑ªÂä†‰∏äÊñ∞Â¢ûÁöÑÊèí‰ª∂ÂêçÁß∞„ÄÇ

#### ÊµãËØï

Â¶ÇÊûúÁ¨¨‰∏ÄÊ¨°ÊâßË°åÂçïÊµãÁöÑÊó∂ÂÄôÈÅáÂà∞Êä•Èîô„ÄêCannot detect source of ....„ÄëÊâßË°å‰ª•‰∏ãÂëΩ‰ª§ËØï‰∏Ä‰∏ã

```
export PERL5LIB=.:$PERL5LIB
// Âú®apisixÈ°πÁõÆÁõÆÂΩï‰∏ã
cd apisix
prove -Itest-nginx/lib -r t/plugin/limit-conn.t
```

#### Êó•ÂøóÊü•Áúã

Âú®ÂçïÂÖÉÊµãËØïÁöÑÊó∂ÂÄôÔºåÈ°πÁõÆÁõÆÂΩï‰∏ãÈù¢‰ºöÂ≠òÂú®servrootÁõÆÂΩïÔºåËØ•ÁõÆÂΩï‰∏ãÈù¢Â≠òÂú®logsÊñá‰ª∂ÔºåÁî®‰∫éÊü•ÁúãÊó•ÂøóÊâìÂç∞Êü•Áúã„ÄÇ

## ÈÖçÁΩÆ

- conf/config.yaml

*Ê≥®ÊÑè* ‰∏çË¶ÅÊâãÂ∑•‰øÆÊîπ APISIX Ëá™Ë∫´ÁöÑ `conf/nginx.conf` Êñá‰ª∂ÔºåÂΩìÊúçÂä°ÊØèÊ¨°ÂêØÂä®Êó∂Ôºå`apisix` ‰ºöÊ†πÊçÆ `config.yaml` ÈÖçÁΩÆËá™Âä®ÁîüÊàêÊñ∞ÁöÑ `conf/nginx.conf` Âπ∂Ëá™Âä®ÂêØÂä®ÊúçÂä°„ÄÇ

## Lua

### ËØ≠Ê≥ï

```lua
local core = require("apisix.core")
# ÂØπË±°ËΩ¨json
core.json.encode(buffers,true)
# ÊâìÂç∞Êó•Âøó
core.log.warn(core.json.encode(conf))
# Â≠óÁ¨¶‰∏≤
local str = [["Lua ÊïôÁ®ã"]]
# ‰ΩøÁî®#Âè∑Ë°®Á§∫ÈïøÂ∫¶
#conf.white_list
```

## Nginx::TEST

ÂèÇËÄÉÊñáÊ°£Ôºö

- [Run Test](https://openresty.gitbooks.io/programming-openresty/content/testing/running-tests.html)
- [‚ùóÔ∏è‚ùóÔ∏è‚ùóÔ∏èTest Nginx ËØ≠Ê≥ïËØ¶ÁªÜËØ¥Êòé](https://github.com/iresty/programming-openresty-zh/blob/master/testing/test-nginx-socket-zh-cn.adoc)

`example.lua`

```lua
local core = require("apisix.core")
local pairs = pairs
local type = type
local ngx = ngx
local buffers = {}
local schema = {
    type = "object",
    properties = {
        message = {
            description = "ÈúÄË¶ÅÊâìÂç∞ÁöÑÊó•Âøó",
            type = "string"
        }
    },
    required = { "message" },
    minProperties = 1,
}

local plugin_name = "example"

local _M = {
    version = 0.1,
    priority = 412,
    name = plugin_name,
    schema = schema,
}

function _M.check_schema(conf)
    local ok, err = core.schema.check(schema, conf)
    if not ok then
        return false, err
    end
    core.log.info("xxxxxxxx: ", "gjx")
    return true
end

function _M.log(conf, ctx)
    buffers.message = conf.message
    core.log.debug("metadata:",core.json.encode(buffers,true))
end

return _M
```

`Example.t`

```demo
use t::APISIX 'no_plan';

repeat_each(1); -- ÈáçÂ§çÊ¨°Êï∞
no_long_string(); -- ÈªòËÆ§Âú∞ÔºåÂ§±Ë¥•ÁöÑÂ≠óÁ¨¶‰∏≤ÂåπÈÖçÊµãËØïÂ∞Ü‰ºö‰ΩøÁî® Test::LongString Ê®°Âùó‰∫ßÁîü‰∏Ä‰∏™ÈîôËØØ‰ø°ÊÅØÔºåÂú® run_tests ‰πãÂâçË∞ÉÁî®Ëøô‰∏™ÂáΩÊï∞Â∞Ü‰ºöÂÖ≥Èó≠ÂÆÉ
no_root_location();
no_shuffle(); -- Âú®no_shuffle()Ë∞ÉÁî®ÁöÑÊÉÖÂÜµ‰∏ãÔºåÊµãËØïÂùóÁöÑËøêË°åÈ°∫Â∫è‰∏éÂÆÉ‰ª¨Âú®ÊµãËØïÊñá‰ª∂‰∏≠Âá∫Áé∞ÁöÑÈ°∫Â∫èÂÆåÂÖ®‰∏ÄËá¥
log_level('debug'); -- Êó•ÂøóÁ∫ßÂà´
run_tests; -- Ëøô‰∏™ÊîæÂú®ÊúÄÂêé

__DATA__

=== TEST 1: sanity  -- Áî®‰æãÂêçÁß∞
--- config   -- Áî®‰∫éÈÖçÁΩÆNginx conf ‰ø°ÊÅØ
    location /t {
        content_by_lua_block {
            local plugin = require("apisix.plugins.example")
             local ctx ={
                headers={
                }
            }
            local ok, err = plugin.check_schema({message="gejiax"})
            if not ok then
                ngx.say(err)
            end
            plugin.log({message="gejiax"},ctx)
            ngx.say("done")  -- ÊâìÂç∞ÁªìÊûú
        }
    }
--- request  -- Ë∞ÉÁî®ËØ∑Ê±Ç,Ê†°È™åÁªìÊûú
GET /t
--- more_headers -- Â§¥ÈÉ®‰ø°ÊÅØ
Authorization: Bearer eyJhbGc
--- response_headers  -- ÂìçÂ∫îËøîÂõûÂ§¥ÈÉ®‰ø°ÊÅØ
in: out
--- error_code: 401 -- Áä∂ÊÄÅÁ†Å
--- response_body  -- ËØ∑Ê±ÇÁªìÊûú
done
--- no_error_log  -- Ë°®Á§∫‰ºöÂØπ nginx ÁöÑ error.log Ê£ÄÊü•ÔºåÂøÖÈ°ªÊ≤°Êúâ EORROR Á∫ßÂà´ÁöÑËÆ∞ÂΩï
[error]
--- response_body_like eval  --ËøîÂõûÂÄºÊ≠£ÂàôË°®ËææÂºèÊ†°È™å
qr/"Access Denied"/
--- error_log eval   --ÈîôËØØÊó•ÂøóÊ≠£ÂàôË°®ËææÂºè
qr/conf_version: \d+#1,/
```

`content_by_lua_block ËØ¥Êòé`

```
=== TEST 12: Add https endpoint with ssl_verify false
--- config
    location /t {
        content_by_lua_block {
            local t = require("lib.test_admin").test  -- Ë∞ÉÁî®apisixÊé•Âè£ÁöÑÂÆûÁé∞ÔºåüëáÂ∞±ÊòØÂ¶Ç‰ΩïÂéªË∞ÉÁî®APIÊé•Âè£ÁöÑÁ§∫‰æã
            local code, body = t('/apisix/admin/routes/1',
                 ngx.HTTP_PUT,
                 [[{
                        "plugins": {
                            "authz-keycloak": {
                                "token_endpoint": "https://127.0.0.1:8443/auth/realms/University/protocol/openid-connect/token",
                                "permissions": ["course_resource#delete"],
                                "client_id": "course_management",
                                "grant_type": "urn:ietf:params:oauth:grant-type:uma-ticket",
                                "timeout": 3000,
                                "ssl_verify": false
                            }
                        },
                        "upstream": {
                            "nodes": {
                                "127.0.0.1:1982": 1
                            },
                            "type": "roundrobin"
                        },
                        "uri": "/hello1"
                }]],
                [[{
                    "node": {
                        "value": {
                            "plugins": {
                                "authz-keycloak": {
                                    "token_endpoint": "https://127.0.0.1:8443/auth/realms/University/protocol/openid-connect/token",
                                    "permissions": ["course_resource#delete"],
                                    "client_id": "course_management",
                                    "grant_type": "urn:ietf:params:oauth:grant-type:uma-ticket",
                                    "timeout": 3000,
                                    "ssl_verify": false
                                }
                            },
                            "upstream": {
                                "nodes": {
                                    "127.0.0.1:1982": 1
                                },
                                "type": "roundrobin"
                            },
                            "uri": "/hello1"
                        },
                        "key": "/apisix/routes/1"
                    },
                    "action": "set"
                }]]
                )

            if code >= 300 then
                ngx.status = code
            end
            ngx.say(body)
        }
    }
--- request
GET /t
--- response_body
passed
--- no_error_log
[error]
```

**HTTP ËØ∑Ê±Ç**

```
location /t {
        content_by_lua_block {
            local json_decode = require("toolkit.json").decode  -- json Â∑•ÂÖ∑Á±ª
            local http = require "resty.http"
            local httpc = http.new()
            local uri = "http://127.0.0.1:8090/auth/realms/University/protocol/openid-connect/token"
            local res, err = httpc:request_uri(uri, {
                    method = "POST",
                    body = "grant_type=password&client_id=course_management&client_secret=d1ec69e9-55d2-4109-a3ea-befa071579d5&username=teacher@gmail.com&password=123456",
                    headers = {
                        ["Content-Type"] = "application/x-www-form-urlencoded"
                    }
                })

            if res.status == 200 then
                local body = json_decode(res.body)
                local accessToken = body["access_token"]


                uri = "http://127.0.0.1:" .. ngx.var.server_port .. "/hello1"
                local res, err = httpc:request_uri(uri, {
                    method = "GET",
                    headers = {
                        ["Authorization"] = "Bearer " .. accessToken,
                    }
                 })

                if res.status == 200 then
                    ngx.say(true)
                else
                    ngx.say(false)
                end
            else
                ngx.say(false)
            end
        }
    }

```

**Â§ö‰∏™location**

```
=== TEST 6: first request timeout
--- config
    location = /aggregate {
        content_by_lua_block {
            local core = require("apisix.core")
            local t = require("lib.test_admin").test
            local code, body = t('/apisix/batch-requests',
                ngx.HTTP_POST,
                [=[{
                    "timeout": 100,
                    "pipeline":[
                    {
                        "path": "/b",
                        "headers": {
                            "Header1": "hello",
                            "Header2": "world"
                        }
                    },{
                        "path": "/c",
                        "method": "PUT"
                    },{
                        "path": "/d"
                    }]
                }]=],
                [=[[
                {
                    "status": 504,
                    "reason": "upstream timeout"
                }
                ]]=]
                )

            ngx.status = code
            ngx.say(body)
        }
    }

    location = /b {
        content_by_lua_block {
            ngx.sleep(1)
            ngx.status = 200
        }
    }
    location = /c {
        content_by_lua_block {
            ngx.status = 201
        }
    }
    location = /d {
        content_by_lua_block {
            ngx.status = 202
        }
    }
--- request
GET /aggregate
--- response_body
passed
--- error_log
timeout
```

## ÈóÆÈ¢ò‰∏éËß£ÂÜ≥ÊñπÊ°à

‚ùì `nginx: [emerg] "listen" directive is not allowed here in /Users/gjason/project/apisix-all/apisix/t/servroot/conf/nginx.conf:188`

ÂèØËÉΩÊòØÊï∞ÊçÆÊ†ºÂºèÈîôËØØÂØºËá¥ nginx.confÈÖçÁΩÆÈîôËØØ„ÄÇ







