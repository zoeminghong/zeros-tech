æœ€è¿‘ç”µè„‘æ›´æ–°ï¼Œæ¢äº†M1çš„ï¼Œä¸€åˆ‡å·¥ä½œé‡æ–°å¼€å§‹ï¼Œæ„å‘³ç€APISIXæ’ä»¶å¼€å‘ä¹‹è·¯ä¸­çš„ç»Šè„šçŸ³â€”â€”å•æµ‹ç¯å¢ƒå‡†å¤‡ï¼Œä¹Ÿè¦é‡æ–°å‡†å¤‡ã€‚

ç”±äºå‡çº§äº†èŠ¯ç‰‡å’Œæœ€æ–°çš„macOSç³»ç»Ÿï¼ˆ12.2.1ï¼‰ï¼Œå¯¼è‡´è¿‡ç¨‹å¹¶æ²¡æœ‰æƒ³è±¡ä¸­çš„é¡ºåˆ©ï¼Œä¹‹å‰æ²¡é‡åˆ°è¿‡çš„å‘ï¼Œä¸€ä¸ªä¸ªçš„æš´éœ²å‡ºæ¥äº†ï¼Œè¿™é‡Œåšä¸€ä¸ªåˆ†äº«å’ŒBackUpã€‚

è¿˜æœ‰æƒ³åæ§½ä¸€ä¸‹APISIXå®˜æ–¹çš„æ–‡æ¡£ï¼Œåœ¨å…³äºå•å…ƒæµ‹è¯•å’Œæ’ä»¶ç¼–å†™æ–¹é¢çš„å†…å®¹ï¼Œè¾“å‡ºä¸æ˜¯ç‰¹åˆ«çš„å¤šï¼Œè€Œä¸”æ•£è½å„å¤„ï¼Œç€å®ç»™å¼€å‘äººå‘˜å¸¦æ¥äº†éº»çƒ¦ã€‚

> ä»¥ä¸‹çš„æ“ä½œéƒ½æ˜¯åŸºäºAPISIXæºç ä¸‹æ“ä½œ(https://github.com/apache/apisix)ï¼Œå†™è¯¥æ–‡æ—¶ç‰ˆæœ¬ä¸ºV2.12.1ã€‚

## æ­£å¸¸å®‰è£…æµç¨‹

1. å®‰è£…å„ç§ç¯å¢ƒä¾èµ–

```shell
    # install OpenResty, etcd and some compilation tools
    brew install openresty/brew/openresty luarocks lua@5.1 etcd curl git pcre openldap cpanminus

    # start etcd server
    brew services start etcd
```
å®˜æ–¹æœ€æ–°æºç ä¸­æä¾›äº†è„šæœ¬ï¼Œä½äº`utils/install-dependencies.sh`ã€‚ç›´æ¥æ‰§è¡Œè¿™ä¸ªè„šæœ¬å°±å¯ä»¥å¯¹ä¸Šæ–¹çš„ä¾èµ–è¿›è¡Œå®‰è£…å’Œå¯åŠ¨ã€‚

[å®˜æ–¹æ–‡æ¡£](https://apisix.apache.org/zh/docs/apisix/next/install-dependencies)

2. ä¿®æ”¹ç¯å¢ƒå˜é‡

ç»“åˆå®é™…å®‰è£…æƒ…å†µä¿®æ”¹`.bash_profile`æ–‡ä»¶ï¼Œå¹¶åˆ«å¿˜äº† `source ~/.bash_profile`ã€‚

```shell
OPENRESTY_HOME=/usr/local/openresty
PATH=$OPENRESTY_HOME/nginx/sbin:$OPENRESTY_HOME/bin:$PATH
export OPENRESTY_HOME

```


3. ä¸‹è½½APISIXæºç 


```shell
git clone https://github.com/apache/apisix.git
```

4. æºç ç¯å¢ƒä¸‹å¤„ç†


```shell
# æºç æ ¹ç›®å½•ä¸‹
git clone https://github.com/iresty/test-nginx.git
rm -rf test-nginx/.git
sudo cpanm --notest Test::Nginx IPC::Run > build.log 2>&1 || (cat build.log && exit 1)
export PERL5LIB=.:$PERL5LIB
make deps
```

æˆ‘çœ‹å®˜æ–¹æ¨èä½¿ç”¨ `make deps ENV_LUAROCKS_SERVER=https://luarocks.cn`ï¼Œä½†æˆ‘è¯•äº†ï¼Œå¹¶æ²¡æœ‰èµ·æ•ˆï¼Œä»æ—§ä½¿ç”¨ https://luarocks.orgï¼Œåæ¥æˆ‘é€šè¿‡ä¿®æ”¹luarocksé…ç½®æ–‡ä»¶ `~/.luarocks/config-5.1.lua` ,ç”Ÿæ•ˆäº†ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥è‡ªå·±è¯•è¯•ï¼Œåœ¨æ–‡ç« ä¸‹æ–¹åšä¸ªåé¦ˆã€‚

[APISIXæ–‡æ¡£](https://apisix.apache.org/zh/docs/apisix/next/FAQ#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%9C%A8%E7%94%A8-luarocks-%E5%AE%89%E8%A3%85-apisix-%E4%BE%9D%E8%B5%96%E6%97%B6%E4%BC%9A%E9%81%87%E5%88%B0%E8%B6%85%E6%97%B6%EF%BC%8C%E5%BE%88%E6%85%A2%E6%88%96%E8%80%85%E4%B8%8D%E6%88%90%E5%8A%9F%E7%9A%84%E6%83%85%E5%86%B5%EF%BC%9F)

```shell
rocks_servers = {
    "https://luarocks.cn"
}
```

ç”±äºgithubçš„ç½‘ç»œåŸå› ï¼Œ`make deps`è¿‡ç¨‹å¯èƒ½ä¸æ˜¯ä¸€å¸†é£é¡ºï¼Œæœ‰ç‚¹è€å¿ƒå¤šè¯•å‡ æ¬¡å°±å¯ä»¥äº†ã€‚

5. ä¸‹è½½ toolkit æ–‡ä»¶

åœ¨`t/`ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ

```shell
git clone https://github.com/api7/test-toolkit toolkit
rm -rf toolkit/.git
```
è¿™é‡Œéœ€è¦é‡å‘½åä¸ºtoolkitï¼Œå¦åˆ™å¼•ç”¨æ‰¾ä¸åˆ°ã€‚

è¿™é‡Œå¦‚æœä¸ä¸‹è½½è¿™ä¸ªæºç ä¼šå¯¼è‡´ï¼Œ`toolkit.json` æ‰¾ä¸åˆ°çš„é—®é¢˜å‡ºç°ã€‚


6. å¯åŠ¨APISIXæœåŠ¡ï¼ˆéå¿…é¡»ï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µï¼‰

æœ¬äººæ˜¯é€šè¿‡Dockeræ–¹å¼å¯åŠ¨


```shell
git clone https://github.com/apache/apisix-docker.git

cd apisix-docker/compose/

docker-compose -f docker-compose.yaml -p docker-apisix up -d
```

è¿™é‡Œéœ€è¦ğŸ“¢æ³¨æ„ï¼Œåœ¨ä¸Šé¢æˆ‘ä»¬å·²ç»å¯åŠ¨äº†etcdï¼Œè¿™é‡Œä¹Ÿä¼šå¯åŠ¨etcdï¼Œæ‰€ä»¥åªè¦é€‰æ‹©å…¶ä¸­ä¸€ä¸ªå°±å¯ä»¥äº†ã€‚


7. æµ‹è¯•ä¸€ä¸‹

åœ¨æºç æ ¹ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ

```
prove -Itest-nginx/lib -r t/plugin/limit-conn.t
```

æ­£å¸¸æƒ…å†µä¸‹è¿™æ ·å­å°±å¯ä»¥å¯åŠ¨äº†ã€‚

ä½†ç°å®æ²¡æœ‰è¿™ä¹ˆé¡ºåˆ©ï¼Œè€Œä¸”ä¸Šé¢çš„æµç¨‹å·²ç»æ˜¯æˆ‘é‡‡å‘çš„ç»“æœäº†ã€‚

## é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### æœ€æ–°ç‰ˆæœ¬ä¸‹æ— æ³•ä½¿ç”¨ brew å®‰è£… openresty

```
% brew install openresty/brew/openresty
Running `brew update --preinstall`...
==> Auto-updated Homebrew!
Updated 1 tap (homebrew/core).
==> Updated Formulae
Updated 10 formulae.

==> Tapping openresty/brew
Cloning into '/opt/homebrew/Library/Taps/openresty/homebrew-brew'...
remote: Enumerating objects: 2866, done.
remote: Counting objects: 100% (34/34), done.
remote: Compressing objects: 100% (28/28), done.
remote: Total 2866 (delta 22), reused 10 (delta 6), pack-reused 2832
Receiving objects: 100% (2866/2866), 627.61 KiB | 638.00 KiB/s, done.
Resolving deltas: 100% (1610/1610), done.
Error: Invalid formula: /opt/homebrew/Library/Taps/openresty/homebrew-brew/Formula/php-session-nginx-module.rb
php-session-nginx-module: Calling bottle :unneeded is disabled! There is no replacement.
Please report this issue to the openresty/brew tap (not Homebrew/brew or Homebrew/core):
  /opt/homebrew/Library/Taps/openresty/homebrew-brew/Formula/php-session-nginx-module.rb:8
```


å®˜æ–¹çš„è§£å†³æ–¹æ¡ˆæ˜¯å°†brewç‰ˆæœ¬ã€‚https://github.com/openresty/openresty/issues/814

[è€Œæˆ‘é€‰æ‹©æ‰‹åŠ¨å®‰è£…openresty](http://openresty.org/cn/installation.html#%E6%9E%84%E5%BB%BA-openresty)


```
tar -xzvf openresty-VERSION.tar.gz
// openresty-VERSION/ ç›®å½•

./configure --prefix=/usr/local/openresty --with-http_addition_module --with-http_flv_module --with-http_gzip_static_module --with-http_realip_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_dav_module --with-http_v2_module --with-pcre=/Users/demo/installapps/pcre-8.45 --with-openssl=/Users/demo/installapps/openssl

make

make install
```

å®‰è£… openresty éœ€è¦ä¾èµ–pcreå’Œopensslï¼Œæ‰€ä»¥è¿™ä¸ªæˆ‘ä»¬ä¹Ÿå¾—æ‰‹åŠ¨å®‰è£…

- opensslï¼šhttps://blog.csdn.net/qyee16/article/details/72799852
- pcreï¼šhttps://www.cnblogs.com/Jordandan/p/10402912.html

è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯pcreè¦ä½¿ç”¨1ï¼Œä¸è¦ä½¿ç”¨2ï¼Œå¦åˆ™ä¼šæœ‰å¦‚ä¸‹é—®é¢˜


```
src/core/ngx_regex.h:15:10: fatal error: 'pcre.h' file not found

#include <pcre.h>

^~~~~~~~

1 error generated.

make[1]: *** [objs/src/core/nginx.o] Error 1

make: *** [install] Error 2
```

[å‚è€ƒæ–‡çŒ®](https://zhuanlan.zhihu.com/p/30831419)

ä¸è¦å¿˜è®°ä¿®æ”¹ç¯å¢ƒå˜é‡å“¦ã€‚

### make deps æ—¶æ‰¾ä¸åˆ°è·¯å¾„é—®é¢˜

å¯ä»¥é€šè¿‡ä½¿ç”¨`ln -s `è½¯é“¾è§£å†³ã€‚

### nginxæŠ¥é”™

è·‘å•æµ‹çš„æ—¶å€™ï¼ŒæŠ¥å¦‚ä¸‹é”™è¯¯

`nginx: [emerg] "listen" directive is not allowed here in /Users/gjason/project/apisix-all/apisix/t/servroot/conf/nginx.conf:188`

å¯èƒ½æ˜¯æ•°æ®æ ¼å¼é”™è¯¯å¯¼è‡´ nginx.confé…ç½®é”™è¯¯ã€‚

ä¹Ÿå¯èƒ½æ˜¯Nginxæ²¡æœ‰å®‰è£…å¥½ï¼Œæ¯”å¦‚ç¼ºå°‘ä¸Šé¢æåˆ°çš„pcreå’Œopensslå¯¼è‡´çš„ã€‚

### Canâ€™t locate t/APISIX.pm in @INC (you may need to install the t::APISIX module)

é—®é¢˜å¤„ç†ï¼š
// æŸ¥çœ‹æ˜¯å¦æœ‰å½“å‰ç›®å½•è·¯å¾„
perl -V

æ·»åŠ å½“å‰ apisix ç›®å½•åˆ° perl æ¨¡å—ç›®å½•ï¼š
// æ·»åŠ å½“å‰ç›®å½•è·¯å¾„ åˆ° perl çš„@INC
`export PERL5LIB=.:$PERL5LIB:/home/apisix_projects/apisix`

å°†å…¶å†™åˆ° `.bash_profile` æ–‡ä»¶ä¸­ã€‚